# V1 Multi-Agent Coaching System

## Overview

The V1 multi-agent system uses three specialized AI coaches that work together to provide personalized, evidence-based support. Each coach focuses on different aspects of behavioral health.

## The Three Coaches

### 1. DBT Coach (Dialectical Behavior Therapy)
**Focus:** Crisis skills, emotion regulation, interpersonal effectiveness

**Detects:**
- Distress tolerance needs ("overwhelming", "can't handle")
- Emotion dysregulation ("mood swings", "out of control")
- Interpersonal challenges ("conflict", "boundary issues")
- Mindfulness opportunities

**Suggests:**
- TIP skills (Temperature, Intense exercise, Paced breathing)
- ACCEPTS distress tolerance techniques
- DEAR MAN interpersonal effectiveness
- Emotion regulation skills

### 2. Self-Compassion Coach
**Focus:** Self-kindness, common humanity, mindful awareness

**Detects:**
- Self-criticism ("I'm a failure", "I'm terrible")
- Shame and embarrassment
- Harsh self-judgment ("should have known better")
- Isolation feelings ("I'm the only one")
- Over-identification with problems ("I am my addiction")

**Suggests:**
- Self-compassion break exercises
- Common humanity reframes
- Self-kindness practices
- Perspective shifts

### 3. CBT Coach (Cognitive Behavioral Therapy)
**Focus:** Cognitive distortions, behavioral patterns, thought restructuring

**Detects:**
- All-or-nothing thinking ("always", "never")
- Catastrophizing ("disaster", "everything will fall apart")
- Mind reading ("they think I'm...")
- Fortune telling ("it's going to be terrible")
- Should statements ("I should", "I must")
- Behavioral activation needs (low motivation, withdrawal)
- Avoidance patterns
- Rumination

**Suggests:**
- Cognitive restructuring
- Thought challenging
- Behavioral activation
- Evidence examination
- Problem-solving

## How They Work Together

### Stage 1: Individual Analysis
Each coach independently analyzes the conversation:
```
User: "I feel like such a failure. I can't handle this stress. 
       I always mess things up."

DBT Coach:     âœ“ Detects: distress-tolerance-needed (75%)
SC Coach:      âœ“ Detects: self-criticism (85%)
CBT Coach:     âœ“ Detects: all-or-nothing thinking (70%)
```

### Stage 2: Event Logging
High-confidence insights (>40%) are stored as CoachEvents:
```json
{
  "coachType": "self-compassion",
  "tags": [
    {
      "type": "emotion",
      "value": "self-criticism",
      "confidence": 0.85
    }
  ],
  "confidence": 0.85
}
```

### Stage 3: Contextual Responses
Tags from previous messages inform future AI responses:
```
System Prompt Enhancement:
"COACH CONTEXT: Based on our conversation, I've noticed signals related to:
- emotion: self-criticism
- behavior: all-or-nothing thinking
- coping-strategy: distress-tolerance-needed

Consider these patterns when responding..."
```

### Stage 4: Plan Synthesis
When sufficient signals are gathered, the Manager AI synthesizes a plan:
```
Input: Recent CoachEvents + Conversation history

Manager AI Process:
1. Extract insights from each coach
2. Prioritize by urgency and feasibility
3. Generate 3-5 specific, actionable items
4. Categorize (immediate/short-term/long-term)
5. Assign difficulty ratings

Output: Personalized Plan with structured actions
```

## Integration Points

### Advice Page (`/advice?v1=1`)

**After each user-assistant exchange:**
```typescript
1. User sends message
2. AI generates response
3. Response displayed to user
4. postToEventsAPI() called in background
5. Coaches analyze conversation
6. Tags extracted and stored
7. If 2+ high-confidence coaches active + 4+ messages:
   â†’ Show plan CTA after 2 seconds
```

**When user accepts plan:**
```typescript
1. User clicks "Yes, create my plan"
2. Show loading state
3. Call /api/plan with message history
4. Plan generated by Manager AI
5. Display plan with categorized actions
6. Add confirmation message to chat
7. User can Accept or Dismiss
```

## API Endpoints

### POST /api/events
**Purpose:** Log coach insights from conversation analysis

**Request:**
```json
{
  "messages": [
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "..."}
  ]
}
```

**Response:**
```json
{
  "success": true,
  "events": [
    {
      "id": "event_...",
      "sessionId": "sess_...",
      "coachType": "self-compassion",
      "tags": [...],
      "confidence": 0.85
    }
  ]
}
```

### POST /api/plan
**Purpose:** Generate personalized action plan

**Request:**
```json
{
  "messages": [
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "..."}
  ]
}
```

**Response:**
```json
{
  "success": true,
  "plan": {
    "id": "plan_...",
    "summary": "...",
    "actions": [
      {
        "id": "action_1",
        "title": "Grounding Technique",
        "description": "When you feel overwhelmed...",
        "category": "immediate",
        "difficulty": "easy"
      }
    ],
    "confidence": 0.8
  }
}
```

### GET /api/events
**Purpose:** Retrieve recent events (debugging)

**Response:**
```json
{
  "success": true,
  "events": [...],
  "count": 10
}
```

### GET /api/plan
**Purpose:** Retrieve latest plan for session

**Response:**
```json
{
  "success": true,
  "plan": {...} | null
}
```

## Feature Flags

Enable V1 features with environment variables:

```bash
# .env.local
FEATURE_V1=1              # Master V1 flag
FEATURE_COACHES=1         # Enable multi-coach analysis
FEATURE_PLAN=1            # Enable plan generation
FEATURE_ONBOARDING_MAP=1  # Enhanced onboarding
```

Enable in browser with URL parameters:
- `/advice?v1=1` - Enable V1 features
- `/advice?v1=1&debug=1` - Show coach debug panel
- `/advice?v1=1&roleplays=1` - Enable roleplay scenarios

## Safety & Guardrails

### Crisis Detection
- Still active at all levels
- Triggers immediately on crisis language
- Bypasses all coach analysis
- Returns safety message directly

### Scope Boundaries
- No diagnosis or medical advice
- Behavior coaching only
- Clear disclaimers
- Professional referrals when appropriate

### Privacy
- All PII redacted before storage
- Session-based, not user-based
- No persistent user data in V1
- In-memory only (cleared on restart)

### Rate Limiting
- 60 requests per minute per session
- Stricter limits for plan generation
- Prevents abuse and cost overruns

## Performance Characteristics

### Response Times
- Events API: ~100-300ms (local analysis)
- Plan API: ~2-4 seconds (OpenAI call)
- Advice API: ~1-3 seconds (streaming response)

### Memory Usage
- Max 1000 events per session
- Max 100 active sessions
- Max 10 plans per session
- Auto-cleanup after 24 hours

### Token Usage (OpenAI)
- Advice response: ~200-600 tokens
- Plan generation: ~400-800 tokens
- Coach context adds: ~50-150 tokens per request

## Testing Scenarios

### Scenario 1: Self-Compassion Flow
```
User: "I'm such a failure. I hate myself for relapsing."
Expected Coaches: Self-Compassion (high), possibly DBT
Expected Plan Focus: Self-kindness, common humanity, shame resilience
```

### Scenario 2: DBT Distress Flow
```
User: "I can't handle this overwhelming feeling. I'm going to explode."
Expected Coaches: DBT (high), possibly Self-Compassion
Expected Plan Focus: Distress tolerance, TIP skills, grounding
```

### Scenario 3: CBT Cognitive Flow
```
User: "Everything always goes wrong. This is going to be a disaster."
Expected Coaches: CBT (high)
Expected Plan Focus: Thought challenging, evidence examination
```

### Scenario 4: Multi-Coach Flow
```
User: "I'm such a failure (SC). I always mess up (CBT). 
       I can't handle this stress (DBT)."
Expected Coaches: All three active
Expected Plan Focus: Integrated approach addressing all patterns
```

## Troubleshooting

### No coaches activating
- Messages too short or generic
- Need stronger emotional/distress signals
- Try longer, more detailed messages

### Plan CTA not appearing
- Need 4+ messages
- Need 2+ high-confidence coaches
- Try clicking "ðŸ’¡ Suggest Plan" manually

### Plan generation fails
- Check OPENAI_API_KEY is valid
- Check feature flags enabled
- Check console for errors

### Empty plan or missing actions
- AI response format may vary
- Parser expects specific format
- Check that summary and actions are present

## Future Enhancements

### V1.1 Planned
- Real-time coach strength meter in UI
- Coach-specific skill suggestions inline
- Plan revision and iteration
- Plan history and tracking

### V2 Planned
- Database persistence
- User accounts
- Progress tracking over time
- Coach learning from feedback
- Multi-session plan continuity



